WITH ExchangeRate AS
(
SELECT ERBUY, RN     
FROM
(
SELECT ERCCY,ERBUY, EREFF,
ROW_NUMBER() OVER (PARTITION BY 1 ORDER BY EREFF DESC) AS RN

FROM 
MR_LFPEXRAT LFP 
INNER JOIN 
Mr_Lfpdcrd Lfpd
ON LFP.ERCCY= LFPD.DCPCCY AND 
   SYSDATE >= Decode(Is_Date_Dapi(To_Char(Ereff)),1,To_Date(To_Char(Ereff),'YYYY-MM-DD'),To_Date('19000101','YYYY-MM-DD')) AND 
   LFPD.DCRTYP='2' AND
   TRIM(LFPD.DCREV) IS NULL
WHERE 
   LFPD.DCPNO='${DCPNO}' and ERBUY!=0

)P
WHERE p.RN=1
)

SELECT P1.DCRDOS_DT AS FIRST_SUBMISSION_DATE, ROUND(P1.FIRST_DEPOSITE_AMOUNT,2) AS FIRST_DEPOSITE_AMOUNT, ROUND(p1.TOTAL_DFC_AMT,2) AS TOTAL_DFC_AMT
FROM
(
SELECT SUM(DCTRAN/DCPRAT) OVER (PARTITION BY  DCPNO ORDER BY Dcrdos desc)  AS TOTAL_DFC_AMT,
(DCTRAN/DCPRAT) AS FIRST_DEPOSITE_AMOUNT,
Decode(Is_Date_Dapi(To_Char(Dcrdos)),1,To_Date(To_Char(Dcrdos),'YYYY-MM-DD'),To_Date('19000101','YYYY-MM-DD')) As DCRDOS_DT,
Row_number() OVER (PARTITION BY 1 ORDER BY Dcrdos asc) AS RNW

FROM MR_LFPDCRD,ExchangeRate A
WHERE DCRTYP ='2' AND TRIM(DCREV) IS NULL AND DCPNO='%policyNumber%'
)P1
Where P1.RNW=1
-------
--INPUT:
--DCPNO : 302-8169005