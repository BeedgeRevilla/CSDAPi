SELECT x.DTEATT, x.PRODTYP, x.FMLYCDE, x.DECFLG, x.PREEXIAFT, x.PREEXIBEF, COUNT(*)
FROM ( 
SELECT  A.CLNTNUM,
        A.MBRNO,
        A.DPNTNO,
        nvl(B.LGIVNAME, ' ') AS LGIVNAME,
        nvl(B.LSURNAME, ' ') AS LSURNAME,
        A.EFFDATE,
        A.PRODTYP,
        A.PLANNO,
        A.DTEATT,
        A.DTETRM,
        A.OCCPCLAS,
        B.CLTDOB,
        B.SECUITYNO,
        ROUND((GCH.CCDATE - B.CLTDOB) / 10000) AS AGE,
        B.CLTSEX,
        B.MARRYD,
        GLHD.DESCN,
        GLH.CLASSINS,
        CASE WHEN A.DESCTABL='T9828' AND A.DESCITEM = GLH.CLASSINS THEN A.LONGDESC ELSE NULL END AS CLASSINS_DESC,
        GLHD.LMTWHOM,
        CASE WHEN A.DESCTABL='TR90G' AND A.DESCITEM = GLHD.LMTWHOM THEN A.LONGDESC ELSE NULL END AS LMTWHOM_DESC,
        GLHD.PROVNET,
        CASE WHEN A.DESCTABL='TR9A4' AND A.DESCITEM = GLHD.PROVNET THEN A.LONGDESC ELSE NULL END AS PROVNET_DESC,
        A.FMLYCDE,
        CASE WHEN A.DESCTABL='T9792' AND A.DESCITEM = A.FMLYCDE THEN A.LONGDESC ELSE NULL END AS FMLYCDE_DESC,
        A.DECFLG,
        CASE WHEN A.DESCTABL='T9798' AND A.DESCITEM = A.DECFLG THEN A.LONGDESC ELSE NULL END AS DECFLG_DESC,
        GPG.GENPLINE,
        
        BNFL.AMTYEAR,
        BNFM.DPNTCOPY,
        BNFM.MBRCOPAY,
        BNFM.CLMWAIT,
        BNFH.BENCDE,
        GLHD.CARDTYPE01,
        GLHD.CARDTYPE02,
        BNFL.AMTLIFE,
        --BNFL.AMTYEAR,
        BNFL.AMTMNTH,
        BNFL.VISLIFE,
        BNFL.VISYEAR,
        BNFL.VISMNTH,
        BNFL.AMTDAY,
        BNFL.AMTVIS,
        BNFL.AMTPROC,
        BNFL.AMTPROPR,
        BNFL.DAYSVIS,
        BNFL.USERDEF,
        BNFL.ZCOPVST,
        BNFL.ZCONSDAY,
        BNFL.BFTFMTYP,
        GPH.PREEXIBEF,
        GPH.PREEXIAFT,
		A.RN
FROM
(
  SELECT TRIM(GMH.CLNTNUM) AS CLNTNUM,
         GMH.CHDRNUM,
         GMH.MBRNO,
         GMH.DPNTNO,
         GMH.OCCPCLAS,
         GMH.FSUCO,
         GMH.CLNTPFX,
         GMH.CHDRCOY,
         GMH.CHDRCOY||GMH.CHDRNUM||GMH.MBRNO||GMH.DPNTNO AS GENPKEY,
         GXH.EFFDATE,
         GXH.PRODTYP,
         GXH.PLANNO,
         GXH.DTEATT,
         GXH.DTETRM,
         GXH.FMLYCDE,
         GXH.DECFLG,
         DES.LONGDESC,
         DES.DESCTABL,
         DES.DESCITEM,
		 ROW_NUMBER() OVER (PARTITION BY TRIM(GMH.CLNTNUM), GMH.CHDRNUM ORDER BY GXH.EFFDATE DESC) RN
         FROM MR_GMHDPF GMH 
              INNER JOIN MR_GXHIPF GXH ON GMH.CHDRNUM= GXH.CHDRNUM AND
                                          GMH.DPNTNO= GXH.DPNTNO  AND
                                          GMH.MBRNO= GXH.MBRNO AND 
                                          (GXH.DTETRM='99999999' OR GXH.DTETRM >= TO_CHAR(SYSDATE,'YYYYMMDD')) AND 
                                          (GMH.DTETRM='99999999' OR GMH.DTETRM >= TO_CHAR(SYSDATE,'YYYYMMDD'))
              INNER JOIN MR_ITEMPF ITE ON ITE.ITEMTABL='T9797' AND 
                                          ITE.ITEMCOY=GXH.CHDRCOY AND 
                                          ITE.ITEMPFX='IT' AND 
                                          ITE.ITEMITEM=GXH.PRODTYP AND 
                                          SUBSTR(ITE.GENAREA,221,1)='N'
              LEFT OUTER JOIN MR_CHDRPF CHD ON CHD.CHDRNUM= 'CH' AND
                                               GMH.CHDRNUM= CHD.CHDRNUM AND
                                               GMH.CHDRCOY= CHD.CHDRCOY  AND
                                               CHD.SERVUNIT= 'GP' 
              LEFT OUTER JOIN MR_DESCPF DES ON CHD.CHDRCOY= DES.DESCCOY AND
                                               DES.DESCPFX= 'IT'  
         WHERE GXH.CHDRNUM ='${POLICY_NO}' AND 
               GXH.MBRNO='${CERT_NO}'
         
)A
INNER JOIN MR_CLNTPF B
  ON A.CLNTNUM = B.CLNTNUM
  AND A.FSUCO = B.CLNTCOY
  AND A.CLNTPFX = B.CLNTPFX
  AND A.RN = 1
  
LEFT OUTER JOIN MR_GLHDPF GLHD 
  ON A.CHDRCOY= GLHD.CHDRCOY AND
     A.CHDRNUM= GLHD.CHDRNUM AND
     A.PRODTYP= GLHD.PRODTYP AND
     A.PLANNO= GLHD.PLANNO 

LEFT OUTER JOIN 
(SELECT GC.CHDRCOY, GC.CHDRNUM, GC.CCDATE FROM 
  (
  SELECT 
    CHDRCOY,
    CHDRNUM,
    CCDATE,
    ROW_NUMBER() OVER (PARTITION BY CHDRCOY, CHDRNUM ORDER BY CCDATE DESC) AS RN
  FROM MR_GCHIPF  
  WHERE TO_DATE(CCDATE,'YYYYMMDD')<= SYSDATE 
  ) GC 
   WHERE GC.RN=1
) GCH
  ON  A.CHDRCOY= GCH.CHDRCOY AND 
      A.CHDRNUM= GCH.CHDRNUM

LEFT OUTER JOIN 
(SELECT GL.CHDRCOY, GL.CHDRNUM, GL.PRODTYP, GL.PLANNO, GL.CLASSINS, GL.EFFDATE FROM 
  (
  SELECT     
    CHDRCOY,
    CHDRNUM,
    PRODTYP,
    PLANNO,
    CLASSINS,
    EFFDATE,
    ROW_NUMBER() OVER (PARTITION BY CHDRCOY, CHDRNUM, PRODTYP, PLANNO ORDER BY EFFDATE DESC) AS RN
  FROM MR_GLHIPF   
  ) GL 
   WHERE GL.RN=1
) GLH
  ON A.CHDRCOY= GLH.CHDRCOY AND
     A.CHDRNUM= GLH.CHDRNUM AND
     A.PRODTYP= GLH.PRODTYP AND
     A.PLANNO= GLH.PLANNO AND
     A.EFFDATE>= GLH.EFFDATE

LEFT OUTER JOIN 
  (SELECT GPGE.* FROM
    (SELECT
     GENPKEY,
     TRANNO,
     LISTAGG(TO_CHAR(GENPLINE),' ') WITHIN GROUP (ORDER BY SEQNOGP) AS GENPLINE,
     ROW_NUMBER() OVER (PARTITION BY GENPKEY ORDER BY TRANNO DESC) AS RN
     FROM MR_GPGEPF
     WHERE GENPTYPE IN (CASE WHEN '${LOB}'='G400' THEN '08' WHEN '${LOB}'='GASIA' THEN '06' ELSE NULL END)
     GROUP BY GENPKEY, TRANNO
    ) GPGE 
   WHERE RN=1
   )GPG 
ON GPG.GENPKEY= A.GENPKEY

LEFT OUTER JOIN MR_BNFHPF BNFH
ON A.CHDRCOY= BNFH.CHDRCOY AND
   A.CHDRNUM= BNFH.CHDRNUM AND
   A.PRODTYP= BNFH.PRODTYP AND
   A.PLANNO= BNFH.PLANNO 
LEFT OUTER JOIN 
 (SELECT BNFLPF.* FROM 
  (
   SELECT 
    CHDRCOY,
    CHDRNUM,
    PRODTYP,
    PLANNO,
    BENCDE,
    AMTLIFE,
    AMTYEAR,
    AMTMNTH,
    VISLIFE,
    VISYEAR,
    VISMNTH,
    AMTDAY,
    AMTVIS,
    AMTPROC,
    AMTPROPR,
    DAYSVIS,
    USERDEF,
    ZCOPVST,
    ZCONSDAY,
    BFTFMTYP,
    ROW_NUMBER() OVER (PARTITION BY CHDRCOY, CHDRNUM, PRODTYP, PLANNO, BENCDE ORDER BY EFFDATE DESC) AS RN
   FROM MR_BNFLPF  
  ) BNFLPF 
   WHERE BNFLPF.RN=1
 ) BNFL
ON GLHD.CHDRCOY= BNFL.CHDRCOY AND
   GLHD.CHDRNUM= BNFL.CHDRNUM AND
   GLHD.PRODTYP= BNFL.PRODTYP AND
   GLHD.PLANNO= BNFL.PLANNO AND
   BNFH.BENCDE= BNFL.BENCDE 
LEFT OUTER JOIN 
 (SELECT BNFMPF.* FROM 
  (
   SELECT 
    CHDRCOY,
    CHDRNUM,
    PRODTYP,
    PLANNO,
    BENCDE,
    ENDDT,
    MBRCOPAY,
    DPNTCOPY,
    CLMWAIT,
    ROW_NUMBER() OVER (PARTITION BY CHDRCOY, CHDRNUM, PRODTYP, PLANNO, BENCDE ORDER BY STRTDT DESC) AS RN
   FROM MR_BNFMPF  
  ) BNFMPF 
   WHERE BNFMPF.RN=1 AND TO_CHAR(SYSDATE,'YYYYMMDD')<= BNFMPF.ENDDT
 ) BNFM
ON A.CHDRCOY= BNFM.CHDRCOY AND
   A.CHDRNUM= BNFM.CHDRNUM AND
   A.PRODTYP= BNFM.PRODTYP AND
   A.PLANNO= BNFM.PLANNO AND
   BNFH.BENCDE= BNFM.BENCDE 
LEFT OUTER JOIN MR_GPHDPF GPH
ON A.CHDRCOY= GPH.CHDRCOY AND
   A.CHDRNUM= GPH.CHDRNUM AND
   A.PRODTYP= GPH.PRODTYP
) x
WHERE x.PRODTYP = '%productCode%'
GROUP BY x.DTEATT, x.PRODTYP, x.FMLYCDE, x.DECFLG, x.PREEXIAFT, x.PREEXIBEF
