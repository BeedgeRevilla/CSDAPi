WITH 
BNFM AS (SELECT BNFMPF.* FROM 
  (
   SELECT 
    CHDRCOY,
    CHDRNUM,
    PRODTYP,
    PLANNO,
    BENCDE,
    ENDDT,
    MBRCOPAY,
    DPNTCOPY,
    CLMWAIT,
    ROW_NUMBER() OVER (PARTITION BY CHDRCOY, CHDRNUM, PRODTYP, PLANNO, BENCDE ORDER BY STRTDT DESC) AS RN
   FROM MR_BNFMPF 
WHERE CHDRNUM = '%policyNumber%' 
  ) BNFMPF 
   WHERE BNFMPF.RN=1 AND TO_CHAR(SYSDATE,'YYYYMMDD')<= BNFMPF.ENDDT
 ), 

 BNFL AS(SELECT BNFLPF.* FROM 
  (
   SELECT 
    CHDRCOY,
    CHDRNUM,
    PRODTYP,
    PLANNO,
    BENCDE,
    AMTLIFE,
    AMTYEAR,
    AMTMNTH,
    VISLIFE,
    VISYEAR,
    VISMNTH,
    AMTDAY,
    AMTVIS,
    AMTPROC,
    AMTPROPR,
    DAYSVIS,
    USERDEF,
    ZCOPVST,
    ZCONSDAY,
    BFTFMTYP,
    ROW_NUMBER() OVER (PARTITION BY CHDRCOY, CHDRNUM, PRODTYP, PLANNO, BENCDE ORDER BY EFFDATE DESC) AS RN
   FROM MR_BNFLPF  
   WHERE CHDRNUM = '%policyNumber%'
  ) BNFLPF 
   WHERE BNFLPF.RN=1
 ), 
BNFH AS (SELECT CHDRNUM, CHDRCOY,PRODTYP,PLANNO, BENCDE  FROM MR_BNFHPF WHERE CHDRNUM = '%policyNumber%')
SELECT  DISTINCT
        A.CLNTNUM,
        A.MBRNO,
        A.DPNTNO,
        NVL(B.LGIVNAME, ' ') AS LGIVNAME,
        NVL(B.LSURNAME, ' ') AS LSURNAME,
        A.EFFDATE,
        A.PRODTYP,
        A.PLANNO,
        A.DTEATT,
        A.DTETRM,
        A.OCCPCLAS,
        B.CLTDOB,
        B.SECUITYNO,
        ROUND((GCH.CCDATE - B.CLTDOB) / 10000) AS AGE,
        B.CLTSEX,
        B.MARRYD, 
        GLHD.DESCN,
        GLH.CLASSINS,
        CASE WHEN A.DESCTABL='T9828' AND A.DESCITEM = GLH.CLASSINS THEN A.LONGDESC ELSE NULL END AS CLASSINS_DESC,
        GLHD.LMTWHOM,
        CASE WHEN A.DESCTABL='TR90G' AND A.DESCITEM = GLHD.LMTWHOM THEN A.LONGDESC ELSE NULL END AS LMTWHOM_DESC,
        GLHD.PROVNET,
        CASE WHEN A.DESCTABL='TR9A4' AND A.DESCITEM = GLHD.PROVNET THEN A.LONGDESC ELSE NULL END AS PROVNET_DESC,
        A.FMLYCDE,
        CASE WHEN A.DESCTABL='T9792' AND A.DESCITEM = A.FMLYCDE THEN A.LONGDESC ELSE NULL END AS FMLYCDE_DESC,
        A.DECFLG,
        CASE WHEN A.DESCTABL='T9798' AND A.DESCITEM = A.DECFLG THEN A.LONGDESC ELSE NULL END AS DECFLG_DESC,
       	A.GENPKEY,    
        BNFL.AMTYEAR,
        BNFM.DPNTCOPY,
        BNFM.MBRCOPAY,
        BNFM.CLMWAIT,
        BNFH.BENCDE,
        GLHD.CARDTYPE01,
        GLHD.CARDTYPE02,
        BNFL.AMTLIFE,
        BNFL.AMTMNTH,
        BNFL.VISLIFE,
        BNFL.VISYEAR,
        BNFL.VISMNTH,
        BNFL.AMTDAY,
        BNFL.AMTVIS,
        BNFL.AMTPROC,
        BNFL.AMTPROPR,
        BNFL.DAYSVIS,
        BNFL.USERDEF,
        BNFL.ZCOPVST,
        BNFL.ZCONSDAY,
        BNFL.BFTFMTYP,
 	A.CHDRCOY

FROM (
WITH CHD AS (
 SELECT  A.CHDRNUM, A.CHDRCOY, B.LONGDESC, B.DESCTABL, B.DESCITEM FROM MR_CHDRPF   A 
  LEFT OUTER JOIN MR_DESCPF B ON A.CHDRCOY= B.DESCCOY WHERE
       B.DESCPFX= 'IT' AND
       A.CHDRPFX= 'CH' AND 
       A.SERVUNIT= 'GP' AND 
       A.CHDRNUM ='%policyNumber%' AND
       B.DESCTABL='T9797'
), 
GXH1 AS (
SELECT GMH.CLNTNUM, GMH.CHDRNUM, GMH.MBRNO, GMH.DPNTNO, GMH.OCCPCLAS, GMH.FSUCO, GMH.CLNTPFX, GMH.CHDRCOY, GXH.EFFDATE,GXH.PRODTYP,GXH.PLANNO,GXH.DTEATT,GXH.DTETRM,GXH.FMLYCDE,GXH.DECFLG, ITE.ITEMCOY,ITE.ITEMITEM 
FROM MR_GMHDPF GMH INNER JOIN MR_GXHIPF GXH ON 
                    GMH.CHDRNUM= GXH.CHDRNUM AND
                    GMH.DPNTNO= GXH.DPNTNO  AND
                    GMH.MBRNO= GXH.MBRNO 
                   INNER JOIN MR_ITEMPF ITE ON 
                    ITE.ITEMCOY=GXH.CHDRCOY AND 
                    ITE.ITEMITEM=GXH.PRODTYP 
      WHERE (GXH.DTETRM='99999999' OR GXH.DTETRM >= TO_CHAR(SYSDATE,'YYYYMMDD')) AND 
            (GMH.DTETRM='99999999' OR GMH.DTETRM >= TO_CHAR(SYSDATE,'YYYYMMDD')) AND 
            GXH.CHDRNUM ='%policyNumber%' AND  GXH.MBRNO='%certificateNumber%' AND
            SUBSTR(GENAREA,221,1)='N' AND ITEMPFX='IT' AND ITEMTABL='T9797')



SELECT  TRIM(GXH1.CLNTNUM) AS CLNTNUM,
         GXH1.CHDRNUM,
         GXH1.MBRNO,
         GXH1.DPNTNO,
         GXH1.OCCPCLAS,
         GXH1.FSUCO,
         GXH1.CLNTPFX,
         GXH1.CHDRCOY,
         GXH1.CHDRCOY||GXH1.CHDRNUM||GXH1.MBRNO||GXH1.DPNTNO AS GENPKEY,
         GXH1.EFFDATE,
         GXH1.PRODTYP,
         GXH1.PLANNO,
         GXH1.DTEATT,
         GXH1.DTETRM,
         GXH1.FMLYCDE,
         GXH1.DECFLG,
         CHD.LONGDESC,
         CHD.DESCTABL,
         CHD.DESCITEM
         FROM GXH1 LEFT OUTER JOIN CHD ON 
                  GXH1.CHDRNUM= CHD.CHDRNUM AND
                  GXH1.CHDRCOY= CHD.CHDRCOY  AND
                  GXH1.PRODTYP = CHD.DESCITEM) A


INNER JOIN MR_CLNTPF B
  ON A.CLNTNUM = B.CLNTNUM
  AND A.FSUCO = B.CLNTCOY
  AND A.CLNTPFX = B.CLNTPFX
  
  
  LEFT OUTER JOIN MR_GLHDPF GLHD 
  ON A.CHDRCOY= GLHD.CHDRCOY AND
     A.CHDRNUM= GLHD.CHDRNUM AND
     A.PRODTYP= GLHD.PRODTYP AND
     A.PLANNO= GLHD.PLANNO 

LEFT OUTER JOIN 
(SELECT GC.CHDRCOY, GC.CHDRNUM, GC.CCDATE FROM 
  (
  SELECT 
    CHDRCOY,
    CHDRNUM,
    CCDATE,
    ROW_NUMBER() OVER (PARTITION BY CHDRCOY, CHDRNUM ORDER BY CCDATE DESC) AS RN
  FROM MR_GCHIPF  
  WHERE TO_DATE(CCDATE,'YYYYMMDD')<= SYSDATE 
  ) GC 
   WHERE GC.RN=1
) GCH
  ON  A.CHDRCOY= GCH.CHDRCOY AND 
      A.CHDRNUM= GCH.CHDRNUM

LEFT OUTER JOIN 
(SELECT GL.CHDRCOY, GL.CHDRNUM, GL.PRODTYP, GL.PLANNO, GL.CLASSINS, GL.EFFDATE FROM 
  (
  SELECT     
    CHDRCOY,
    CHDRNUM,
    PRODTYP,
    PLANNO,
    CLASSINS,
    EFFDATE,
    ROW_NUMBER() OVER (PARTITION BY CHDRCOY, CHDRNUM, PRODTYP, PLANNO ORDER BY EFFDATE DESC) AS RN
  FROM MR_GLHIPF   
  ) GL 
   WHERE GL.RN=1
) GLH
  ON A.CHDRCOY= GLH.CHDRCOY AND
     A.CHDRNUM= GLH.CHDRNUM AND
     A.PRODTYP= GLH.PRODTYP AND
     A.PLANNO= GLH.PLANNO 
     
LEFT OUTER JOIN BNFH
ON A.CHDRCOY= BNFH.CHDRCOY AND
   A.CHDRNUM= BNFH.CHDRNUM AND
   A.PRODTYP= BNFH.PRODTYP AND
   A.PLANNO= BNFH.PLANNO 
LEFT OUTER JOIN BNFL
ON GLHD.CHDRCOY= BNFL.CHDRCOY AND
   GLHD.CHDRNUM= BNFL.CHDRNUM AND
   GLHD.PRODTYP= BNFL.PRODTYP AND
   GLHD.PLANNO= BNFL.PLANNO AND
   BNFH.BENCDE= BNFL.BENCDE 
LEFT OUTER JOIN BNFM
ON A.CHDRCOY= BNFM.CHDRCOY AND
   A.CHDRNUM= BNFM.CHDRNUM AND
   A.PRODTYP= BNFM.PRODTYP AND
   A.PLANNO= BNFM.PLANNO AND
   BNFH.BENCDE= BNFM.BENCDE 

   WHERE  A.EFFDATE>= GLH.EFFDATE
   AND A.DPNTNO = '%DependentNumber%'
   AND A.PRODTYP = '%productCode%'
   AND BNFH.BENCDE = '%benefitCd%'
