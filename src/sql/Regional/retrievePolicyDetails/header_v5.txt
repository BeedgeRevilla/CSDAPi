Select
        C.CHDRNUM AS CHDRNUM,
        C.COWNNUM AS COWNNUM,
        C.STATCODE AS STATCODE,
        C.CNTTYPE AS CNTTYPE,
        C.EFFDCLDT AS EFFDCLDT,
        C.OCCDATE AS OCCDATE,
        C.SRCEBUS AS SRCEBUS,
        B.CCDATE AS CCDATE,
        B.CRDATE AS CRDATE,
        B.BILLFREQ AS BILLFREQ,
        B.CNTBRANCH AS CNTBRANCH,
        B.AGNTNUM AS AGNTNUM,
        nvl(GCPPF.FMRPOL, ' ') AS FMRPOL,
        nvl(DES.LONGDESC, ' ') AS LONGDESC,
        nvl(CLN.LSURNAME, ' ') AS LSURNAME_OWNER,
        nvl(CLN.LGIVNAME, ' ') AS LGIVNAME,
        B.BTDATENR AS BTDATENR,
        nvl(AGN.LSURNAME, ' ') AS LSURNAME_PRODUCER
       
        FROM
      (
      SELECT CHDRNUM,
       CNTTYPE,
       STATCODE,
       COWNNUM,
       TRANID,
       COWNCOY,
       COWNPFX,
       EFFDCLDT,
       OCCDATE,
       SRCEBUS
       FROM
      (
      SELECT CHD.CHDRNUM,
       CHD.CNTTYPE,
       CHD.STATCODE,
       TRIM(CHD.COWNNUM) as COWNNUM,
       CHD.TRANID,
       CHD.COWNCOY,
       CHD.COWNPFX,
       CHD.EFFDCLDT,
       CHD.OCCDATE,
       CHD.SRCEBUS,
       RANK() OVER (PARTITION BY CHD.CHDRNUM ORDER BY CHD.TRANNO DESC) AS   Rnk
       FROM
        MR_CHDRPF CHD
        WHERE           
           SERVUNIT= 'GP'           
           AND CHDRNUM in ('%policyNumber%')    /*INPUT POLICY NUMBER */           
) CHDRPF where CHDRPF.RNK = 1
)C
INNER JOIN
  (
  select
   G.CCDATE,
   G.CRDATE,
   G.BILLFREQ,
   G.CNTBRANCH,
   G.CHDRNUM,
   G.AGNTNUM,
   G.BTDATENR,
   G.AGNTCOY,
   G.AGNTPFX
   FROM
  (
  SELECT  GCH.CCDATE,
       GCH.CRDATE,
       GCH.BILLFREQ,
       GCH.CNTBRANCH,
       GCH.CHDRNUM,
       GCH.AGNTNUM,
       GCH.BTDATENR,
       GCH.AGNTCOY,
       GCH.AGNTPFX,
        RANK() OVER (PARTITION BY GCH.CHDRNUM ORDER BY GCH.TRANNO DESC) AS   Rnk
        FROM
MR_GCHIPF GCH
where GCH.CHDRNUM in ('%policyNumber%')
) G
where G.RNK = 1
)B
  ON C.CHDRNUM=B.CHDRNUM
INNER JOIN MR_GCHPPF GCPPF
  ON C.CHDRNUM = GCPPF.CHDRNUM
  LEFT OUTER JOIN MR_DESCPF DES
  ON C.CNTTYPE= DES.DESCITEM AND DES.DESCTABL='T9799'
  INNER JOIN MR_CLNTPF CLN
  ON C.COWNNUM= CLN.CLNTNUM
  AND C.COWNCOY = CLN.CLNTCOY
  AND C.COWNPFX = CLN.CLNTPFX
  LEFT OUTER JOIN 
    (
    SELECT 
      CLNT.LSURNAME,
      AG.AGNTNUM,
      AG.AGNTCOY,
      AG.AGNTPFX
    FROM MR_CLNTPF CLNT 
    INNER JOIN MR_AGNTPF AG
  ON CLNT.CLNTNUM= AG.CLNTNUM
  AND CLNT.CLNTCOY = AG.CLNTCOY
    ) AGN
  ON B.AGNTNUM = AGN.AGNTNUM AND 
     B.AGNTCOY = AGN.AGNTCOY AND
     B.AGNTPFX = AGN.AGNTPFX
  
  
