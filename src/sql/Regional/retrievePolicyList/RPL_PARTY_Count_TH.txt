SELECT POLICY_NO, COUNT(COVERAGE_CD) AS TOTAL_RISK_COUNT  FROM (	WITH PR1 AS 	( SELECT POLICY_RK FROM 		(	SELECT  PP.POLICY_RK,	ROW_NUMBER() OVER ( PARTITION BY PP.POLICY_ROLE_RK ORDER BY PP.VALID_FROM_DTTM DESC,PP.TRANS_NO DESC ) AS VALID_REC			FROM					(					SELECT  PRP.TRANS_NO,PRP.POLICY_ROLE_RK,PRP.POLICY_RK,PRP.VALID_FROM_DTTM				FROM PARTY_ROLE_POLICY PRP				INNER JOIN PARTY PR ON PR.PARTY_RK=PRP.PARTY_RK AND PRP.PARTY_ROLE_CD='OWN' WHERE  TO_DATE('%toDate%','YYYY-MM-DD') >= PRP.VALID_FROM_DTTM  /*VALUE  OF VALID FROM DATE*/ AND TO_DATE('%toDate%','YYYY-MM-DD') <= PRP.VALID_TO_DTTM  /*VALUE VALID TO DATE*/   AND EXISTS(	SELECT PARTY_RK FROM 		(	SELECT PARTY_RK FROM PARTY_IDENTIFIER 			WHERE ID_DOC_TYPE_CD='SECURITYNO'		AND SRCH_ID_DOC_NO LIKE UPPER(REGEXP_REPLACE(REVERSE('%idDocumentNumber%'), '[^0-9A-Za-z]', '')||'%') /*VALUE OF TAX_ID*/		)PI	WHERE PR.PARTY_RK=PI.PARTY_RK)  	
			) PP
			
		) 
	 WHERE VALID_REC=1
	)
  SELECT POLICY_NO, COVERAGE_CD,PROD_CD
	FROM
	(
		SELECT POL_COV.POLICY_NO,POL_COV.POLICY_RK,RI.COVERAGE_CD,PDT.PROD_CD		
		FROM
		PR1
		INNER JOIN 
		(  SELECT POLICY_NO,POLICY_RK,SERVICING_AGNT_1_RK, prod_rk FROM 
			(
				SELECT
				PL.POLICY_NO,PL.POLICY_RK,PL.SERVICING_AGNT_1_RK, PL.prod_rk,
				ROW_NUMBER() OVER ( PARTITION BY PL.POLICY_RK ORDER BY PL.VALID_FROM_DTTM DESC,PL.TRANS_NO DESC ) AS VALID_REC
				FROM POLICY PL
				inner join PR1 on PR1.policy_rk=PL.policy_rk
				WHERE TO_DATE('%toDate%','YYYY-MM-DD') >= PL.VALID_FROM_DTTM /*VALUE OF VALID  FROM DATE FIELD*/
				
				 AND TO_DATE('%toDate%','YYYY-MM-DD') <= PL.VALID_TO_DTTM /*VALUE OF VALID TO DATE FIELD*/   )
			WHERE VALID_REC=1 
		) POL_COV ON PR1.POLICY_RK=POL_COV.POLICY_RK
		LEFT OUTER JOIN AGENT AG ON POL_COV.SERVICING_AGNT_1_RK=AG.AGNT_RK
		LEFT OUTER JOIN PRODUCT PDT ON PDT.PROD_RK=POL_COV.PROD_RK
LEFT OUTER JOIN 
			(
				SELECT POLICY_RK, COVERAGE_TYPE_CD, COVERAGE_CD, VALID_FROM_DTTM, VALID_TO_DTTM
				FROM
				(
					SELECT PI.POLICY_RK, PI.COVERAGE_TYPE_CD, PI.COVERAGE_CD, PI.VALID_FROM_DTTM, PI.VALID_TO_DTTM,
					ROW_NUMBER() OVER (PARTITION BY PI.POLICY_RK, PI.COVERAGE_TYPE_CD, PI.COVERAGE_CD ORDER BY PI.VALID_FROM_DTTM DESC, PI.TRANS_NO DESC) V_REC
					FROM POLICY_ITEM PI 
					INNER JOIN PR1 --POL_COV CHANGE ON 05/10/2018
					--ON POL_COV.POLICY_RK = PI.POLICY_RK AND TO_DATE('2016-06-10','YYYY-MM-DD') >= PI.VALID_FROM_DTTM 
					ON PR1.POLICY_RK = PI.POLICY_RK AND TO_DATE('%toDate%','YYYY-MM-DD') >= PI.VALID_FROM_DTTM --POL_COV CHANGE ON 05/10/2018
					AND TO_DATE('%toDate%','YYYY-MM-DD') <= PI.VALID_TO_DTTM /* VALUE FOR VALID TO DATE FIELD */
					AND PI.COVERAGE_CD != '0'
					AND PI.COVERAGE_TYPE_CD IS NOT NULL
					) WHERE V_REC =1
			)RI
			ON POL_COV.POLICY_RK = RI.POLICY_RK   )TBL  ) GROUP BY POLICY_NO