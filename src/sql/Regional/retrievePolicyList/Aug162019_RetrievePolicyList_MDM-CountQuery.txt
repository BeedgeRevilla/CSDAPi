SELECT COUNT(1)  AS TOTAL_RECORD_SET
FROM
(
WITH PR AS
(
SELECT *
FROM
(
SELECT
PP.AFFILIATE_CD,PP.CERTIFICATE_NO,PP.DEPENDENT_NO,PP.BENEFICIARY_ID,POLICY_RK,PP.PARTY_ROLE_CD,PP.PARTY_RK,PP.TRANS_NO,PP.POLICY_ROLE_RK,
PP.COMPANY_CD,PP.PARTY_ID,PP.PARTY_STAT_CD,PP.LOCAL_FIRST_NM,PP.LOCAL_LAST_NM,
PP.LOCAL_DISPLAY_NM_FORMAT,PP.GENDER_CD,PP.BIRTH_DT,PP.FORM_60_FLG,PP.IDENTITY_PROOF_IND,PP.SALUTATION_TXT,
PP.MARITAL_STAT_CD,PP.NATIONALITY_CD,PP.GEO_DEMOGRAPHIC_CD,PP.COUNTRY_OF_RESIDENCE_CD,PP.OCCUPATION_CLASS_CD,
PP.DECEASED_FLG,PP.DEATH_DT,PP.ALERT_RECEIVER_NM,PP.SOURCE_OF_INCOME,PP.ANNUAL_INCOME_AMT,PP.ANNUAL_INCOME_RANGE_CD,
PP.EDUCATION_LEVEL_CD,PP.HEIGHT_IN_MTR,PP.WEIGHT_IN_KG,PP.STF_NO,PP.STF_FLG,PP.PRIMARY_LANG_CD,PP.SPCL_NEED_CD,
PP.PREF_CONTACT_METHOD_CD,PP.STD_GENDER_CD,PP.STD_MARITAL_STAT_CD,PP.STD_NATIONALITY_CD,PP.STD_OCCUPATION_CLASS_CD,
PP.FIRST_NM,
PP.LAST_NM,
PP.DISPLAY_NM_FORMAT ,
PP.PARTY_TYPE_CD,
PP.MDM_ID,
ROW_NUMBER() OVER ( PARTITION BY PP.POLICY_ROLE_RK ORDER BY PP.TRANS_NO DESC ) AS VALID_REC
FROM
(
SELECT
PRP.AFFILIATE_CD,PRP.CERTIFICATE_NO,PRP.DEPENDENT_NO,PRP.BENEFICIARY_ID,POLICY_RK,PRP.PARTY_ROLE_CD,PRP.PARTY_RK,PRP.TRANS_NO,PRP.POLICY_ROLE_RK,
PR.COMPANY_CD,PR.PARTY_ID,PR.PARTY_STAT_CD,PR.LOCAL_FIRST_NM,PR.LOCAL_LAST_NM,
PR.LOCAL_DISPLAY_NM_FORMAT,PR.GENDER_CD,PR.BIRTH_DT,PR.FORM_60_FLG,PR.IDENTITY_PROOF_IND,PR.SALUTATION_TXT,
PR.MARITAL_STAT_CD,PR.NATIONALITY_CD,PR.GEO_DEMOGRAPHIC_CD,PR.COUNTRY_OF_RESIDENCE_CD,PR.OCCUPATION_CLASS_CD,
PR.DECEASED_FLG,PR.DEATH_DT,PR.ALERT_RECEIVER_NM,PR.SOURCE_OF_INCOME,PR.ANNUAL_INCOME_AMT,PR.ANNUAL_INCOME_RANGE_CD,
PR.EDUCATION_LEVEL_CD,PR.HEIGHT_IN_MTR,PR.WEIGHT_IN_KG,PR.STF_NO,PR.STF_FLG,PR.PRIMARY_LANG_CD,PR.SPCL_NEED_CD,
PR.PREF_CONTACT_METHOD_CD,PR.STD_GENDER_CD,PR.STD_MARITAL_STAT_CD,PR.STD_NATIONALITY_CD,PR.STD_OCCUPATION_CLASS_CD,
PR.FIRST_NM,
PR.LAST_NM,
PR.DISPLAY_NM_FORMAT ,
PR.PARTY_TYPE_CD,
MV.MDM_ID
FROM PARTY_ROLE_POLICY PRP
INNER JOIN PARTY PR ON PR.PARTY_RK=PRP.PARTY_RK
LEFT OUTER JOIN PARTY_SK PS
ON PR.PARTY_RK = PS.PARTY_RK
INNER JOIN VW_CROSS_REF MV
ON MV.ENTITY_CD||':'||MV.PARTY_ID= PS.PARTY_BK
WHERE  TO_DATE('%toDate%','YYYY-MM-DD') >= PRP.VALID_FROM_DTTM  /*VALUE  OF VALID FROM DATE*/
AND ADD_MONTHS(TO_DATE('%toDate%','YYYY-MM-DD'), -12) <= PRP.VALID_TO_DTTM  /*VALUE VALID TO DATE*/
--AND PRP.PARTY_ROLE_CD='OWN'
AND MV.MDM_ID = '%masterIndividualPartyId%'
AND EXISTS (SELECT CASE WHEN SOURCE_SYSTEM_CD IN ('G400','GASIA') THEN 'INS' ELSE 'OWN' END AS PR_CD FROM PARTY_ROLE_POLICY)
) PP
)
WHERE VALID_REC=1  /* Required for Wild card search */
)
SELECT  
POLICY_NUMBER
FROM
(
SELECT
TBL.POLICY_NUMBER
FROM
(
SELECT
POL_COV.POLICY_NO AS "POLICY_NUMBER"
FROM
PR
INNER JOIN
(
SELECT * FROM
(
SELECT
PL.VALID_FROM_DTTM,PL.TRANS_NO,PL.VALID_TO_DTTM,PL.LAST_MODIFIED_BY,PL.LAST_MODIFIED_DTTM,PL.ETL_BATCH_ID,PL.SOURCE_SYSTEM_CD,
PL.ENTITY_CD,PL.COMPANY_CD,PL.POLICY_NO,PL.PROD_RK,PL.APPL_NO,PL.POLICY_RK,PL.PRODUCING_AGNT_1_RK,PL.PRODUCING_AGNT_2_RK,PL.SERVICING_AGNT_1_RK,
PL.SERVICING_AGNT_2_RK,PL.ISSUING_BRANCH_1_RK,PL.ISSUING_BRANCH_2_RK,PL.VERSION_NO,PL.ISSUE_TYPE_CD,PL.LOB_CD,PL.STD_LOB_CD,PL.PREVIOUS_POLICY_NO,
PL.SOURCE_CHNL_CD,PL.STD_SOURCE_CHNL_CD,PL.ORIGINAL_INCEPTION_DT,PL.POLICY_ISSUE_DT,PL.POLICY_EFF_DT,PL.POLICY_EXPIRATION_DT,PL.POLICY_TERMINATION_DT,PL.POLICY_RNWL_DT,
PL.POLICY_STAT_CD,PL.PAID_TO_DT,PL.PAYMENT_MODE_CD,PL.REFERERER_ID,PL.JACKET_CD,PL.POLICY_CURRENCY_CD,PL.STD_CURRENCY_CD,PL.HEALTH_COV_FLG,PL.GRP_POLICY_FLG,
PL.GROSS_PREM_AMT,PL.NET_PREM_AMT,PL.LAST_PAYMENT_DT,PL.LF_SUM_INSURED_AMT,PL.LF_MOD_PREM_AMT,
ROW_NUMBER() OVER ( PARTITION BY pl.POLICY_RK ORDER BY pl.TRANS_NO DESC ) AS VALID_REC
FROM POLICY PL
INNER JOIN PR ON PR.POLICY_RK=PL.POLICY_RK      
WHERE   TO_DATE('%toDate%','YYYY-MM-DD') >= pl.VALID_FROM_DTTM  /*VALUE  OF VALID FROM DATE*/
AND ADD_MONTHS(TO_DATE('%toDate%','YYYY-MM-DD'), -12) <= pl.VALID_TO_DTTM  /*VALUE VALID TO DATE*/  )
WHERE VALID_REC=1
) POL_COV ON PR.POLICY_RK=POL_COV.POLICY_RK
LEFT OUTER JOIN AGENT AG ON POL_COV.SERVICING_AGNT_1_RK=AG.AGNT_RK
LEFT OUTER JOIN PRODUCT PDT ON PDT.PROD_RK=POL_COV.PROD_RK
)TBL
)
)