-- COUNT QUERY

SELECT  COUNT(*) AS TOTAL_REC_COUNT FROM 
(
	WITH POL_COV AS
	(
		SELECT * FROM 
		(
			SELECT   
			CM.CLAIM_NO AS "CLAIM_NUMBER",
			CM.CLAIM_TYPE_CD AS "CLAIM_TYPE",
			PA.FIRST_NM AS "FIRST_NAME",
			PA.LAST_NM AS "LAST_NAME",
			CM.LOSS_REPORT_DT AS "SUBMISSION_DT",
			CM.TOT_SHORTFALL_AMT AS "SHORTFALL_AMT",
			CM.TOT_OUTSTANDING_AMT AS "REMAINING_BENEFIT_BALANCE",
			CM.ADMISSION_DT AS "ADMISSION_DATE",
			CM.STD_CLAIM_STAT_CD AS "CLAIM_STATUS_CD",
			CM.TOT_PAID_AMT AS "CLAIM_AMOUNT_PAID",
			CM.LOSS_DT AS "LOSS_DATE",
			CM.TOT_APPRVD_AMT AS "CLAIM_AMOUNT_PAYABLE",
			CM.CLAIM_CLOSE_DT AS "COMPLETION_DATE",
			CM.PRE_AUTH_NO,CM.COV_CD,CM.COV_NO,CM.CLAIM_OPEN_DT,CM.DISCHARGE_DT,CM.POLICY_RK,
			CM.CLAIM_PAYMENT_DT,CM.CLAIM_SETTLEMENT_TYPE_CD,CM.CLAIM_CURRENCY_CD,CM.TOT_CLAIM_AMT,CM.PREVIOUS_CLAIM_NO,CM.COMPANY_CD,
			PA.DISPLAY_NM_FORMAT,
			PCM.PARTY_ROLE_ID,PCM.PARTY_ROLE_CD,
			CM.CLAIM_HIST_RK,
			PA.PARTY_ID,CM.ADJUSTMENT_NO,CM.CLAIM_REF_ID,CM.ICF_FLG,
			CM.DEPENDENT_NO AS "DEPENDENT_NUMBER",CM.CLAIM_DESC AS CLAIM_DESCRIPTION
			FROM CLAIM CM INNER JOIN PARTY_ROLE_CLAIM PCM ON CM.CLAIM_RK=PCM.CLAIM_RK
			LEFT OUTER JOIN PARTY PA ON PCM.PARTY_RK=PA.PARTY_RK
			${whereCondition}
		)
	)
	SELECT 
	
		POL_COV.CLAIM_NUMBER,
		POL.POLICY_NO AS POLICY_NUMBER,
		POL_COV.CLAIM_TYPE,
		POL_COV.FIRST_NAME,
		POL_COV.LAST_NAME,
		POL_COV.SUBMISSION_DT,
		POL_COV.SHORTFALL_AMT,
		POL_COV.REMAINING_BENEFIT_BALANCE ,
		POL_COV.ADMISSION_DATE,
		POL_COV.CLAIM_STATUS_CD,
		POL_COV.CLAIM_AMOUNT_PAID,
		POL_COV.LOSS_DATE,
		POL_COV.CLAIM_AMOUNT_PAYABLE,
		POL_COV.COMPLETION_DATE,
		POL_COV.PRE_AUTH_NO,
		POL_COV.COV_CD,
		POL_COV.COV_NO,
		POL_COV.CLAIM_OPEN_DT,
		POL_COV.DISCHARGE_DT,
		POL_COV.CLAIM_PAYMENT_DT,
		POL_COV.CLAIM_SETTLEMENT_TYPE_CD,
		POL_COV.CLAIM_CURRENCY_CD,
		POL_COV.TOT_CLAIM_AMT,
		POL_COV.PREVIOUS_CLAIM_NO,
		POL_COV.DISPLAY_NM_FORMAT,
		POL.SOURCE_SYSTEM_CD,
		POL.ENTITY_CD,
		POL_COV.COMPANY_CD,
		POL.STD_LOB_CD,
		POL_COV.PARTY_ID,
		POL_COV.ADJUSTMENT_NO,	
		POL_COV.CLAIM_REF_ID,	
		POL_COV.ICF_FLG,	
		POL_COV.DEPENDENT_NUMBER,	
		POL_COV.CLAIM_DESCRIPTION	

	FROM 
	POL_COV 
	INNER JOIN 
	(
		SELECT * FROM 
		(
			SELECT
			PL.*
			,ROW_NUMBER() OVER ( PARTITION BY PL.POLICY_RK ORDER BY PL.TRANS_NO DESC ) AS VALID_REC
			FROM POLICY PL
			INNER JOIN POL_COV ON POL_COV.POLICY_RK=PL.POLICY_RK
			${whereConditionPolicy}
		)
		WHERE VALID_REC=1 
	) POL ON POL_COV.POLICY_RK=POL.POLICY_RK
)
