WITH POL_COV AS
(
	SELECT /*+ FIRST_ROWS(50) */  *  /* Required for Wild Card Search */
	FROM 
	(
		SELECT 
		PL.VALID_FROM_DTTM,PL.TRANS_NO,PL.VALID_TO_DTTM,PL.LAST_MODIFIED_BY,PL.LAST_MODIFIED_DTTM,PL.ETL_BATCH_ID,PL.SOURCE_SYSTEM_CD,
		PL.ENTITY_CD,PL.COMPANY_CD,PL.POLICY_NO,PL.PROD_RK,PL.APPL_NO,PL.POLICY_RK,PL.PRODUCING_AGNT_1_RK,PL.PRODUCING_AGNT_2_RK,
		PL.SERVICING_AGNT_1_RK,PL.SERVICING_AGNT_2_RK,PL.ISSUING_BRANCH_1_RK,PL.ISSUING_BRANCH_2_RK,PL.VERSION_NO,PL.ISSUE_TYPE_CD,
		PL.LOB_CD,PL.STD_LOB_CD,PL.PREVIOUS_POLICY_NO,PL.SOURCE_CHNL_CD,PL.STD_SOURCE_CHNL_CD,PL.ORIGINAL_INCEPTION_DT,PL.POLICY_ISSUE_DT,
		PL.POLICY_EFF_DT,PL.POLICY_EXPIRATION_DT,PL.POLICY_TERMINATION_DT,PL.POLICY_RNWL_DT,PL.POLICY_STAT_CD,PL.PAID_TO_DT,PL.PAYMENT_MODE_CD,
		PL.REFERERER_ID,PL.JACKET_CD,PL.POLICY_CURRENCY_CD,PL.STD_CURRENCY_CD,PL.HEALTH_COV_FLG,PL.GRP_POLICY_FLG,PL.SRCH_APPL_NO,PL.STD_POLICY_STAT_CD,PL.STD_PAYMENT_MODE_CD,
		ROW_NUMBER() OVER ( PARTITION BY POLICY_RK ORDER BY TRANS_NO DESC ) AS VALID_REC
		FROM POLICY PL
		WHERE 
		PL.SRCH_POLICY_NO=UPPER(REGEXP_REPLACE('${policyNumber}', '[^0-9a-zA-Z]', '')) /*VALUE OF POLICY NUMBER*/ 		   
	)
	WHERE VALID_REC=1 
	AND ROWNUM<=50   /* Required for Wild Card Search */
)

SELECT 
	CLAIM_NUMBER,
	POLICY_NUMBER,
	CLAIM_TYPE,
	FIRST_NAME,
	LAST_NAME,
	SUBMISSION_DT,
	SHORTFALL_AMT,
	REMAINING_BENEFIT_BALANCE,
	ADMISSION_DATE,
	CLAIM_STATUS_CD,
	CLAIM_AMOUNT_PAID,
	LOSS_DATE,
	CLAIM_AMOUNT_PAYABLE,
	COMPLETION_DATE,
	PRE_AUTH_NO,
	COV_CD,
	COV_NO,
	CLAIM_OPEN_DT,
	DISCHARGE_DT,
	CLAIM_PAYMENT_DT,
	CLAIM_SETTLEMENT_TYPE_CD,
	CLAIM_CURRENCY_CD,
	TOT_CLAIM_AMT,
	PREVIOUS_CLAIM_NO,
	DISPLAY_NM_FORMAT,
	SOURCE_SYSTEM_CD,
	ENTITY_CD,
	COMPANY_CD,
	STD_LOB_CD,
	PARTY_ID,
	VIP_FLAG,
	ADJUSTMENT_NO,
	CLAIM_REF_ID,
	ICF_FLG,
	DEPENDENT_NUMBER,
	CLAIM_DESCRIPTION,
	--APPROVAL_REMARKS1,
	--APPROVAL_REMARKS2,
	--REJECT_RSN,
	--CLAIM_TRANS_DT,
	PARTY_TYPE_CD,
	
	PARTY_STAT_CD,
	CHANNEL,
	TRANS_NO,
	LOCAL_FIRST_NM,
	LOCAL_LAST_NM,
	LOCAL_DISPLAY_NM_FORMAT,
	GENDER_CD,
	BIRTH_DT,
	FORM_60_FLG,
	IDENTITY_PROOF_IND,
	SALUTATION_TXT,
	MARITAL_STAT_CD,
	NATIONALITY_CD,
	GEO_DEMOGRAPHIC_CD,
	COUNTRY_OF_RESIDENCE_CD,
	OCCUPATION_CLASS_CD,
	DECEASED_FLG,
	DEATH_DT,
	ALERT_RECEIVER_NM,
	SOURCE_OF_INCOME,
	ANNUAL_INCOME_AMT,
	ANNUAL_INCOME_RANGE_CD,
	EDUCATION_LEVEL_CD,
	HEIGHT_IN_MTR,
	WEIGHT_IN_KG,
	STF_NO,
	STF_FLG,
	PRIMARY_LANG_CD,
	SPCL_NEED_CD,
	PREF_CONTACT_METHOD_CD,
	STD_GENDER_CD,
	STD_MARITAL_STAT_CD,
	STD_NATIONALITY_CD,
	STD_OCCUPATION_CLASS_CD,
	STD_GEO_DEMOGRAPHIC_CD,
	STD_EDUCATION_LEVEL_CD,
	STD_PRIMARY_LANG_CD,
	STD_SPCL_NEED_CD,
	STD_PREF_CONTACT_METHOD_CD,
	APPL_NO,
	VERSION_NO,
	ISSUE_TYPE_CD,
	LOB_CD,
	PREVIOUS_POLICY_NO,
	STD_SOURCE_CHNL_CD,
	ORIGINAL_INCEPTION_DT,
	POLICY_ISSUE_DT,
	POLICY_EFF_DT,
	POLICY_EXPIRATION_DT,
	POLICY_TERMINATION_DT,
	POLICY_RNWL_DT,
	POLICY_STAT_CD,
	PAID_TO_DT,
	PAYMENT_MODE_CD,
	REFERERER_ID,
	JACKET_CD,
	POLICY_CURRENCY_CD,
	STD_CURRENCY_CD,
	HEALTH_COV_FLG,
	GRP_POLICY_FLG,
	STD_POLICY_STAT_CD,
	STD_PAYMENT_MODE_CD,
	SRCH_APPL_NO,
	PARTY_ROLE_ID,
	PARTY_ROLE_CD,
	MIDDLE_NM,
	SMOKING_HABIT,
	SPCL_CASE_CD,
	BANKRUPTCY_FLAG,
	FRAUD_CD,
	LOCAL_MIDDLE_NM,
	AMOUNT_BILLED, 
	CLIENT_CLAIM_REF_NO,
	PROV_ORG
	
	
	FROM
	(
	
	SELECT 
	CLAIM_NUMBER,
	POLICY_NUMBER,
	CLAIM_TYPE,
	FIRST_NAME,
	LAST_NAME,
	SUBMISSION_DT,
	SHORTFALL_AMT,
	REMAINING_BENEFIT_BALANCE,
	ADMISSION_DATE,
	CLAIM_STATUS_CD,
	CLAIM_AMOUNT_PAID,
	LOSS_DATE,
	CLAIM_AMOUNT_PAYABLE,
	COMPLETION_DATE,
	PRE_AUTH_NO,
	COV_CD,
	COV_NO,
	CLAIM_OPEN_DT,
	DISCHARGE_DT,
	CLAIM_PAYMENT_DT,
	CLAIM_SETTLEMENT_TYPE_CD,
	CLAIM_CURRENCY_CD,
	TOT_CLAIM_AMT,
	PREVIOUS_CLAIM_NO,
	DISPLAY_NM_FORMAT,
	SOURCE_SYSTEM_CD,
	ENTITY_CD,
	COMPANY_CD,
	STD_LOB_CD,
	PARTY_ID,
	
	PARTY_TYPE_CD,
	PARTY_STAT_CD,
	CHANNEL,
	TRANS_NO,
	LOCAL_FIRST_NM,
	LOCAL_LAST_NM,
	LOCAL_DISPLAY_NM_FORMAT,
	GENDER_CD,
	BIRTH_DT,
	FORM_60_FLG,
	IDENTITY_PROOF_IND,
	SALUTATION_TXT,
	MARITAL_STAT_CD,
	NATIONALITY_CD,
	GEO_DEMOGRAPHIC_CD,
	COUNTRY_OF_RESIDENCE_CD,
	OCCUPATION_CLASS_CD,
	DECEASED_FLG,
	DEATH_DT,
	ALERT_RECEIVER_NM,
	SOURCE_OF_INCOME,
	ANNUAL_INCOME_AMT,
	ANNUAL_INCOME_RANGE_CD,
	EDUCATION_LEVEL_CD,
	HEIGHT_IN_MTR,
	WEIGHT_IN_KG,
	STF_NO,
	STF_FLG,
	PRIMARY_LANG_CD,
	SPCL_NEED_CD,
	PREF_CONTACT_METHOD_CD,
	STD_GENDER_CD,
	STD_MARITAL_STAT_CD,
	STD_NATIONALITY_CD,
	STD_OCCUPATION_CLASS_CD,
	STD_GEO_DEMOGRAPHIC_CD,
	STD_EDUCATION_LEVEL_CD,
	STD_PRIMARY_LANG_CD,
	STD_SPCL_NEED_CD,
	STD_PREF_CONTACT_METHOD_CD,
	APPL_NO,
	VERSION_NO,
	ISSUE_TYPE_CD,
	LOB_CD,
	PREVIOUS_POLICY_NO,
	STD_SOURCE_CHNL_CD,
	ORIGINAL_INCEPTION_DT,
	POLICY_ISSUE_DT,
	POLICY_EFF_DT,
	POLICY_EXPIRATION_DT,
	POLICY_TERMINATION_DT,
	POLICY_RNWL_DT,
	POLICY_STAT_CD,
	PAID_TO_DT,
	PAYMENT_MODE_CD,
	REFERERER_ID,
	JACKET_CD,
	POLICY_CURRENCY_CD,
	STD_CURRENCY_CD,
	HEALTH_COV_FLG,
	GRP_POLICY_FLG,
	STD_POLICY_STAT_CD,
	STD_PAYMENT_MODE_CD,
	SRCH_APPL_NO,
	PARTY_ROLE_ID,
	PARTY_ROLE_CD,
	MIDDLE_NM,
	SMOKING_HABIT,
	SPCL_CASE_CD,
	CLAIM_HIST_RK,
	BANKRUPTCY_FLAG,
	FRAUD_CD,
	LOCAL_MIDDLE_NM,
	VIP_FLAG,
	ADJUSTMENT_NO,
	CLAIM_REF_ID,
	ICF_FLG,
	DEPENDENT_NUMBER,
	CLAIM_DESCRIPTION,
	AMOUNT_BILLED, 
	CLIENT_CLAIM_REF_NO,
	PROV_ORG,
	ROWNUM AS RNUM
	
	FROM
		
	(
		SELECT /*+ FIRST_ROWS(50) */   /* Required for Wild Card Search */
		TBL.CLAIM_NUMBER,
		TBL.POLICY_NUMBER,
		CASE WHEN SUBSTR(TBL.CLAIM_TYPE,1,3)='CL_' THEN SUBSTR(TBL.CLAIM_TYPE,4)
		     WHEN SUBSTR(TBL.CLAIM_TYPE,1,3)='HC_' THEN SUBSTR(TBL.CLAIM_TYPE,4)
			 ELSE TBL.CLAIM_TYPE
		END AS CLAIM_TYPE,
		TBL.FIRST_NAME,
		TBL.LAST_NAME,
		TBL.SUBMISSION_DT,
		TBL.SHORTFALL_AMT,
		TBL.REMAINING_BENEFIT_BALANCE,
		TBL.ADMISSION_DATE,
		TBL.CLAIM_STATUS_CD,
		TBL.CLAIM_AMOUNT_PAID,
		TBL.CHANNEL,
		TBL.LOSS_DATE,
		TBL.CLAIM_AMOUNT_PAYABLE,
		TBL.COMPLETION_DATE,
		TBL.PRE_AUTH_NO,
		TBL.COV_CD,
		TBL.COV_NO,
		TBL.CLAIM_OPEN_DT,
		TBL.DISCHARGE_DT,
		TBL.CLAIM_PAYMENT_DT,
		TBL.CLAIM_SETTLEMENT_TYPE_CD,
		TBL.CLAIM_CURRENCY_CD,
		TBL.TOT_CLAIM_AMT,
		TBL.PREVIOUS_CLAIM_NO,
		TBL.PARTY_TYPE_CD,
		TBL.PARTY_STAT_CD,
		TBL.DISPLAY_NM_FORMAT,
		TBL.LOCAL_FIRST_NM,
		TBL.LOCAL_LAST_NM,
		TBL.LOCAL_DISPLAY_NM_FORMAT,
		TBL.GENDER_CD,
		TBL.BIRTH_DT,
		TBL.FORM_60_FLG,
		TBL.IDENTITY_PROOF_IND,
		TBL.SALUTATION_TXT,
		TBL.MARITAL_STAT_CD,
		TBL.NATIONALITY_CD,
		TBL.GEO_DEMOGRAPHIC_CD,
		TBL.COUNTRY_OF_RESIDENCE_CD,
		TBL.OCCUPATION_CLASS_CD,
		TBL.DECEASED_FLG,
		TBL.DEATH_DT,
		TBL.ALERT_RECEIVER_NM,
		TBL.SOURCE_OF_INCOME,
		TBL.ANNUAL_INCOME_AMT,
		TBL.ANNUAL_INCOME_RANGE_CD,
		TBL.EDUCATION_LEVEL_CD,
		TBL.HEIGHT_IN_MTR,
		TBL.WEIGHT_IN_KG,
		TBL.STF_NO,
		TBL.STF_FLG,
		TBL.PRIMARY_LANG_CD,
		TBL.SPCL_NEED_CD,
		TBL.CLAIM_HIST_RK,
		TBL.PREF_CONTACT_METHOD_CD,
		TBL.STD_GENDER_CD,
		TBL.STD_MARITAL_STAT_CD,
		TBL.STD_NATIONALITY_CD,
		TBL.STD_OCCUPATION_CLASS_CD,
		TBL.STD_GEO_DEMOGRAPHIC_CD,
		TBL.STD_EDUCATION_LEVEL_CD,
		TBL.STD_PRIMARY_LANG_CD,
		TBL.STD_SPCL_NEED_CD,
		TBL.STD_PREF_CONTACT_METHOD_CD,
		TBL.SOURCE_SYSTEM_CD,
		TBL.ENTITY_CD,
		TBL.TRANS_NO,
		TBL.COMPANY_CD,
		TBL.APPL_NO,
		TBL.VERSION_NO,
		TBL.ISSUE_TYPE_CD,
		TBL.LOB_CD,
		TBL.STD_LOB_CD,
		TBL.PREVIOUS_POLICY_NO,
		TBL.STD_SOURCE_CHNL_CD,
		TBL.ORIGINAL_INCEPTION_DT,
		TBL.POLICY_ISSUE_DT,
		TBL.POLICY_EFF_DT,
		TBL.POLICY_EXPIRATION_DT,
		TBL.POLICY_TERMINATION_DT,
		TBL.POLICY_RNWL_DT,
		TBL.POLICY_STAT_CD,
		TBL.PAID_TO_DT,
		TBL.PAYMENT_MODE_CD,
		TBL.REFERERER_ID,
		TBL.JACKET_CD,
		TBL.POLICY_CURRENCY_CD,
		TBL.STD_CURRENCY_CD,
		TBL.HEALTH_COV_FLG,
		TBL.GRP_POLICY_FLG,
		TBL.STD_POLICY_STAT_CD,
		TBL.STD_PAYMENT_MODE_CD,
		TBL.SRCH_APPL_NO,
		TBL.PARTY_ROLE_ID,
		TBL.PARTY_ROLE_CD,
		TBL.MIDDLE_NM,
		TBL.SMOKING_HABIT,
		TBL.SPCL_CASE_CD,
		TBL.BANKRUPTCY_FLAG,
		TBL.FRAUD_CD,
		TBL.LOCAL_MIDDLE_NM,
		TBL.VIP_FLAG,
		TBL.PARTY_ID,
		TBL.ADJUSTMENT_NO,
		TBL.CLAIM_REF_ID,
		TBL.ICF_FLG,
		TBL.DEPENDENT_NUMBER,
		TBL.CLAIM_DESCRIPTION,
		TBL.AMOUNT_BILLED, 
		TBL.CLIENT_CLAIM_REF_NO,
		TBL.PROV_ORG
		
		FROM
		(
			SELECT 
			CM.CLAIM_NO AS "CLAIM_NUMBER",
			POL_COV.POLICY_NO AS "POLICY_NUMBER",
			CM.CLAIM_TYPE_CD AS "CLAIM_TYPE",
			PA.FIRST_NM AS "FIRST_NAME",
			PA.LAST_NM AS "LAST_NAME",
			CM.LOSS_REPORT_DT AS "SUBMISSION_DT",
			CM.TOT_SHORTFALL_AMT AS "SHORTFALL_AMT",
			CM.TOT_OUTSTANDING_AMT AS "REMAINING_BENEFIT_BALANCE",
			CM.ADMISSION_DT AS "ADMISSION_DATE",
			CM.STD_CLAIM_STAT_CD AS "CLAIM_STATUS_CD",
			CM.TOT_PAID_AMT AS "CLAIM_AMOUNT_PAID",
			POL_COV.SOURCE_CHNL_CD AS "CHANNEL",
			CM.LOSS_DT AS "LOSS_DATE",
			CM.TOT_APPRVD_AMT AS "CLAIM_AMOUNT_PAYABLE",
			CM.CLAIM_CLOSE_DT AS "COMPLETION_DATE",
			CM.COMPANY_CD,CM.VERSION_NO,CM.PRE_AUTH_NO,CM.LOB_CD,CM.COV_CD,CM.COV_NO,CM.CLAIM_OPEN_DT,CM.DISCHARGE_DT,
			CM.CLAIM_PAYMENT_DT,CM.CLAIM_SETTLEMENT_TYPE_CD,CM.CLAIM_CURRENCY_CD,CM.TOT_CLAIM_AMT,CM.PREVIOUS_CLAIM_NO,
			PA.PARTY_TYPE_CD,PA.PARTY_STAT_CD,PA.DISPLAY_NM_FORMAT,PA.LOCAL_FIRST_NM,PA.LOCAL_LAST_NM,PA.LOCAL_DISPLAY_NM_FORMAT,PA.GENDER_CD,PA.BIRTH_DT,
			PA.FORM_60_FLG,PA.IDENTITY_PROOF_IND,PA.SALUTATION_TXT,PA.MARITAL_STAT_CD,PA.NATIONALITY_CD,PA.GEO_DEMOGRAPHIC_CD,PA.COUNTRY_OF_RESIDENCE_CD,PA.OCCUPATION_CLASS_CD,
			PA.DECEASED_FLG,PA.DEATH_DT,PA.ALERT_RECEIVER_NM,PA.SOURCE_OF_INCOME,PA.ANNUAL_INCOME_AMT,PA.ANNUAL_INCOME_RANGE_CD,PA.EDUCATION_LEVEL_CD,PA.HEIGHT_IN_MTR,
			PA.WEIGHT_IN_KG,PA.STF_NO,PA.STF_FLG,PA.PRIMARY_LANG_CD,PA.SPCL_NEED_CD,PA.PREF_CONTACT_METHOD_CD,PA.STD_GENDER_CD,PA.STD_MARITAL_STAT_CD,PA.STD_NATIONALITY_CD,
			PA.STD_OCCUPATION_CLASS_CD,PA.STD_GEO_DEMOGRAPHIC_CD,PA.STD_EDUCATION_LEVEL_CD,PA.STD_PRIMARY_LANG_CD,PA.STD_SPCL_NEED_CD,PA.STD_PREF_CONTACT_METHOD_CD,
			POL_COV.SOURCE_SYSTEM_CD,POL_COV.ENTITY_CD,POL_COV.TRANS_NO,POL_COV.APPL_NO,POL_COV.ISSUE_TYPE_CD,
			POL_COV.STD_LOB_CD,POL_COV.PREVIOUS_POLICY_NO,POL_COV.STD_SOURCE_CHNL_CD,POL_COV.ORIGINAL_INCEPTION_DT,POL_COV.POLICY_ISSUE_DT,
			POL_COV.POLICY_EFF_DT,POL_COV.POLICY_EXPIRATION_DT,POL_COV.POLICY_TERMINATION_DT,POL_COV.POLICY_RNWL_DT,POL_COV.POLICY_STAT_CD,POL_COV.PAID_TO_DT,
			POL_COV.PAYMENT_MODE_CD,POL_COV.REFERERER_ID,POL_COV.JACKET_CD,POL_COV.POLICY_CURRENCY_CD,POL_COV.STD_CURRENCY_CD,POL_COV.HEALTH_COV_FLG,POL_COV.GRP_POLICY_FLG,
			POL_COV.STD_POLICY_STAT_CD,POL_COV.STD_PAYMENT_MODE_CD,POL_COV.SRCH_APPL_NO,
			PCM.PARTY_ROLE_ID,PCM.PARTY_ROLE_CD,CM.CLAIM_HIST_RK,
			PA.MIDDLE_NM,PA.SMOKING_HABIT,PA.SPCL_CASE_CD,PA.BANKRUPTCY_FLAG,PA.FRAUD_CD,PA.LOCAL_MIDDLE_NM,PA.VIP_FLAG,PA.PARTY_ID,CM.ADJUSTMENT_NO,CM.CLAIM_REF_ID,CM.ICF_FLG,
			CM.DEPENDENT_NO AS DEPENDENT_NUMBER,CM.CLAIM_DESC AS CLAIM_DESCRIPTION,
			CM.AMOUNT_BILLED, CM.CLIENT_CLAIM_REF_NO, CM.PROV_ORG
			FROM  POL_COV
			INNER JOIN CLAIM CM ON POL_COV.POLICY_RK=CM.POLICY_RK
			LEFT OUTER JOIN PARTY_ROLE_CLAIM PCM ON PCM.CLAIM_RK=CM.CLAIM_RK
			LEFT OUTER JOIN PARTY PA ON PCM.PARTY_RK=PA.PARTY_RK
			
			${whereCondition}
	)TBL
		ORDER BY TBL.CLAIM_NUMBER
		)
ORDER BY ${sortingCondition}
)
WHERE RNUM >= '${MIN_ROWS}'
AND RNUM <= '${MAX_ROWS}'