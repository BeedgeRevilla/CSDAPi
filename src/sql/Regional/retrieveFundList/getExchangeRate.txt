SELECT *
FROM (
    SELECT FUND_CODE,
    FUND_CURRENCY,
      ERBUY AS EXCHANGE_RATE_VALUE,
      Q47LUPDT AS EXCHANGE_RATE_DATE
    FROM
      (SELECT NVL(TRIM(L9CCY),M0FCCY) AS FUND_CURRENCY,
        Q47LUPDT,
        FUND_CODE
      FROM
        (SELECT DTB.M0FCDE AS FUND_CODE,
          DTB.M0FCCY ,
          BFBI.Q47LUPDT,
          DECODE(BFBI.Q47PNO, NULL, 1, ROW_NUMBER() OVER (PARTITION BY BFBI.Q47CODE, BFBI.Q47PNO ORDER BY BFBI.Q47LUPDT DESC))
    RN
        FROM MR_LFPPMFN MFN
        LEFT OUTER JOIN MR_LFPFNDTB DTB
        ON TRIM(DTB.M0FCDE)=TRIM(MFN.M4CODE)
        LEFT OUTER JOIN MR_LFPCDBFBI BFBI
        ON BFBI.Q47PNO        =MFN.M4PNO
        AND TRIM(BFBI.Q47CODE)=TRIM(MFN.M4CODE)
        WHERE MFN.M4PNO       ='%policyNumber%' /*INPUT POLICY NUMBER*/
        )TBL
      LEFT OUTER JOIN
        (SELECT *
        FROM
          (SELECT L9CCY,
            L9CODE,
            ROW_NUMBER() OVER (PARTITION BY L9CODE ORDER BY L9CODE) AS RN
          FROM MR_TABPLANF
          )PLAN
        )PLANF
      ON TRIM(TBL.FUND_CODE)=TRIM(PLANF.L9CODE)
      WHERE PLANF.RN        = 1
      AND TBL.RN            = 1
      ) RFL1
    LEFT OUTER JOIN MR_LFPEXRAT EXR
    ON RFL1.Q47LUPDT       = EXR.EREFF
    AND RFL1.FUND_CURRENCY = EXR.ERCCY
)WHERE FUND_CODE = '%fundCode%'