SELECT 
ACD.EFFDATE,	/*ADDED FOR AUTOMATION */
DECODE(IS_DATE(TO_CHAR(ACD.EFFDATE)),1,TO_DATE(TO_CHAR(ACD.EFFDATE),'YYYY-MM-DD'),TO_DATE('19000101','YYYY-MM-DD')),
ACD.MANDSTAT,
ACD.MANDREF,
ACD.BANK_ACC_NUMBER,
ACD.CREDIT_CARD_NUMBER,
ACD.BANKKEY,  /*FIELD ADDED. CORRESPONDING CR: SC-721*/
ACD.BANKDESC, /*FIELD ADDED AS PER NEW REQUIREMENT*/

ACD.PAYRCOY,
ACD.PAYRNUM,
ACD.VALIDFLAG,
ACD.TIMES_USE,
ACD.STAT_CHANGE_DATE,
ACD.LAST_USE_DATE,
ACD.LAST_USE_AMT,
ACD.LU_STAT_CODE,
ACD.MAND_AMT,
ACD.TERMID,
ACD."USER",
ACD.TRANSACTION_DATE,
ACD.TRANSACTION_TIME,
ACD.DETLSUMM,
ACD.ZSHFDD,
ACD.FACTHOUS
FROM 
(
 WITH MSTR_MAND_VIEW
 AS
 (
  SELECT PAYRNUM, MANDREF, MAX(STAT_CHANGE_DATE) AS STAT_CHANGE_DATE
  FROM  MR_MANDPF
  WHERE PAYRNUM = '%partyId%' /* INPUT PAYER NUMBER */
  AND MANDREF =  '%mandref%'    /* INPUT MANDATE REFERENCE NUMBER */
/*  AND MANDSTAT = '10'*/
  AND  VALIDFLAG  = 1
  AND  STAT_CHANGE_DATE <> 99999999
  GROUP BY PAYRNUM,MANDREF
 ) 
 
 SELECT 
 MAND.EFFDATE,
 MAND.MANDSTAT,
 MAND.MANDREF,
 (SELECT BANKACCKEY
  FROM MR_MANDPF MND 
  INNER JOIN  MSTR_MAND_VIEW MMV 
  ON MND.PAYRNUM=MMV.PAYRNUM AND MND.MANDREF=MMV.MANDREF AND MND.STAT_CHANGE_DATE = MMV.STAT_CHANGE_DATE
  WHERE BANKKEY NOT IN ('VISA', 'MASTER','NBVISA','HSVISA','CREDITCARD')
 ) AS BANK_ACC_NUMBER,
 (SELECT BANKACCKEY
  FROM MR_MANDPF MND 
  INNER JOIN  MSTR_MAND_VIEW MMV 
  ON MND.PAYRNUM=MMV.PAYRNUM AND MND.MANDREF=MMV.MANDREF AND MND.STAT_CHANGE_DATE = MMV.STAT_CHANGE_DATE 
  WHERE BANKKEY IN ('VISA', 'MASTER','NBVISA', 'HSVISA','CREDITCARD')
 ) AS CREDIT_CARD_NUMBER,
 MAND.PAYRCOY,
 MAND.PAYRNUM,
 MAND.VALIDFLAG,
 CASE 
 WHEN LENGTH(MAND.BANKKEY)>3 THEN MAND.BANKKEY
 ELSE NULL
 END BANKKEY, /*CHANGE DONE CORRESPONDING CR: SC-721*/
 MAND.TIMES_USE,
 MAND.STAT_CHANGE_DATE,
 MAND.LAST_USE_DATE,
 MAND.LAST_USE_AMT,
 MAND.LU_STAT_CODE,
 MAND.MAND_AMT,
 MAND.TERMID,
 MAND."USER",
 MAND.TRANSACTION_DATE,
 MAND.TRANSACTION_TIME,
 MAND.DETLSUMM,
 MAND.ZSHFDD,
 MAND.FACTHOUS,
 SUBSTR(BA.BANKDESC,1,30) BANKDESC
 FROM 
 MR_MANDPF MAND
 INNER JOIN
 MSTR_MAND_VIEW MMV
 ON
 MAND.PAYRNUM=MMV.PAYRNUM AND MAND.MANDREF=MMV.MANDREF AND MAND.STAT_CHANGE_DATE=MMV.STAT_CHANGE_DATE
 LEFT OUTER JOIN MR_BABRPF BA ON MAND.BANKKEY=BA.BANKKEY
 
 UNION
  
 SELECT 
 MAND.EFFDATE,
 MAND.MANDSTAT,
 MAND.MANDREF,
 (SELECT BANKACCKEY
  FROM MR_MANDPF 
  WHERE BANKKEY NOT IN ('VISA', 'MASTER','NBVISA','HSVISA','CREDITCARD') 
  AND PAYRNUM = '%partyId%' /* INPUT PAYER NUMBER */
  AND MANDREF =  '%mandref%' /* INPUT MANDATE REFERENCE NUMBER */
  AND STAT_CHANGE_DATE = 99999999  /*AND MANDSTAT = '10'*/ AND  VALIDFLAG  = 1 AND ROWNUM<=1
 ) AS BANK_ACC_NUMBER,
 (SELECT BANKACCKEY
  FROM MR_MANDPF 
  WHERE BANKKEY  IN ('VISA', 'MASTER','NBVISA',  'HSVISA','CREDITCARD') 
  AND PAYRNUM = '%partyId%' /* INPUT PAYER NUMBER */
  AND MANDREF =  '%mandref%' /* INPUT MANDATE REFERENCE NUMBER */
  AND STAT_CHANGE_DATE = 99999999 /* AND MANDSTAT = '10'*/ AND  VALIDFLAG  = 1 AND ROWNUM<=1
 ) AS CREDIT_CARD_NUMBER,
 MAND.PAYRCOY,
 MAND.PAYRNUM,
 MAND.VALIDFLAG,
 CASE 
 WHEN LENGTH(MAND.BANKKEY)>3 THEN MAND.BANKKEY
 ELSE NULL
 END BANKKEY, /*CHANGE DONE CORRESPONDING CR: SC-721*/
 MAND.TIMES_USE,
 MAND.STAT_CHANGE_DATE,
 MAND.LAST_USE_DATE,
 MAND.LAST_USE_AMT,
 MAND.LU_STAT_CODE,
 MAND.MAND_AMT,
 MAND.TERMID,
 MAND."USER",
 MAND.TRANSACTION_DATE,
 MAND.TRANSACTION_TIME,
 MAND.DETLSUMM,
 MAND.ZSHFDD,
 MAND.FACTHOUS,
 SUBSTR(BA.BANKDESC,1,30) BANKDESC
 FROM 
 MR_MANDPF MAND
 LEFT OUTER JOIN MR_BABRPF BA ON MAND.BANKKEY=BA.BANKKEY
 WHERE 
 MAND.PAYRNUM = '%partyId%'  /* INPUT PAYER NUMBER */
 AND MAND.MANDREF =  '%mandref%'    /* INPUT MANDATE REFERENCE NUMBER */
 /*AND MAND.MANDSTAT='10'*/ AND MAND.VALIDFLAG='1' AND MAND.STAT_CHANGE_DATE=99999999
 AND MAND.PAYRNUM NOT IN ( SELECT PAYRNUM FROM MSTR_MAND_VIEW)
) ACD
